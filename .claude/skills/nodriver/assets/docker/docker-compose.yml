version: '3.8'

services:
  nodriver-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nodriver-automation

    # Environment variables
    environment:
      - DISPLAY=:99
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      # Add your app-specific env vars here
      - TARGET_URL=${TARGET_URL:-https://example.com}
      - HEADLESS=${HEADLESS:-false}

    # Volumes for persistence
    volumes:
      # Application code (for development)
      - ./app:/app
      # Downloads directory
      - ./downloads:/app/downloads
      # Browser profiles for session persistence
      - ./profiles:/app/profiles
      # Cookies storage
      - ./cookies:/app/cookies
      # Logs
      - ./logs:/app/logs

    # Network configuration
    networks:
      - automation-net

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

    # Health check
    healthcheck:
      test: ["CMD", "pgrep", "-f", "chrome"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Restart policy
    restart: unless-stopped

    # Security options
    security_opt:
      - no-new-privileges:true

    # Capabilities (needed for Chrome)
    cap_add:
      - SYS_ADMIN

  # Optional: Redis for task queue
  redis:
    image: redis:7-alpine
    container_name: nodriver-redis
    networks:
      - automation-net
    volumes:
      - redis-data:/data
    restart: unless-stopped
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

networks:
  automation-net:
    driver: bridge

volumes:
  redis-data: